# 데이터 흐름 상세 문서

## 전체 시스템 아키텍처

```
┌─────────────┐
│  클라이언트  │
│  (브라우저)  │
└──────┬──────┘
       │
       │ HTTP/SSE
       │
┌──────▼──────────────────────────────┐
│         웹 서버 (Backend)            │
│  ┌──────────────────────────────┐   │
│  │  API 라우터                  │   │
│  └──────────────────────────────┘   │
│  ┌──────────────────────────────┐   │
│  │  파일 업로드 핸들러           │   │
│  └──────────────────────────────┘   │
│  ┌──────────────────────────────┐   │
│  │  번역 작업 큐/워커            │   │
│  └──────────────────────────────┘   │
│  ┌──────────────────────────────┐   │
│  │  동영상 처리 모듈             │   │
│  │  (키포인트 추출/그리기)       │   │
│  └──────────────────────────────┘   │
│  ┌──────────────────────────────┐   │
│  │  수어 인식 모델               │   │
│  └──────────────────────────────┘   │
│  ┌──────────────────────────────┐   │
│  │  사전 데이터베이스            │   │
│  └──────────────────────────────┘   │
│  ┌──────────────────────────────┐   │
│  │  임시 파일 저장소             │   │
│  └──────────────────────────────┘   │
└─────────────────────────────────────┘
```

---

## 시나리오별 상세 데이터 흐름

### 시나리오 1: 동작 검색 및 번역 (전체 플로우)

#### 1단계: 동영상 업로드
```
[클라이언트]                    [서버]
     │                            │
     │── POST /api/upload ────────>│
     │   (multipart/form-data)     │
     │   file: video.mp4           │
     │                            │
     │                            │── 파일 검증
     │                            │── 임시 저장
     │                            │── file_id 생성
     │                            │
     │<── 200 OK ──────────────────│
     │   {                         │
     │     "file_id": "abc123",    │
     │     "filename": "video.mp4" │
     │   }                         │
     │                            │
     │ [GUI에 업로드 성공 표시]    │
```

#### 2단계: 번역 작업 시작
```
[클라이언트]                    [서버]
     │                            │
     │── POST /api/translate ────>│
     │   { "file_id": "abc123" }  │
     │                            │
     │                            │── 작업 큐에 추가
     │                            │── task_id 생성
     │                            │── 비동기 작업 시작
     │                            │
     │<── 200 OK ──────────────────│
     │   {                         │
     │     "task_id": "task_456"   │
     │   }                         │
     │                            │
     │ [번역 시작 메시지 표시]     │
```

#### 3단계: 진행 상황 모니터링 (SSE)
```
[클라이언트]                    [서버]
     │                            │
     │── GET /api/translate/      │
     │   progress/task_456 ───────>│
     │   (SSE 연결)                │
     │                            │
     │                            │── SSE 스트림 시작
     │                            │
     │<── event: progress ─────────│
     │   data: {                   │
     │     "progress": 10,         │
     │     "message": "동영상 분석 중..."│
     │   }                         │
     │                            │
     │ [프로그레스 바 업데이트]    │
     │                            │
     │                            │── 키포인트 추출 중
     │                            │
     │<── event: progress ─────────│
     │   data: {                   │
     │     "progress": 40,         │
     │     "message": "키포인트 추출 중..."│
     │   }                         │
     │                            │
     │ [프로그레스 바 업데이트]    │
     │                            │
     │                            │── 모델 분석 중
     │                            │
     │<── event: progress ─────────│
     │   data: {                   │
     │     "progress": 70,         │
     │     "message": "수어 인식 중..."│
     │   }                         │
     │                            │
     │ [프로그레스 바 업데이트]    │
     │                            │
     │                            │── 키포인트 그리기
     │                            │
     │<── event: progress ─────────│
     │   data: {                   │
     │     "progress": 90,         │
     │     "message": "결과 생성 중..."│
     │   }                         │
     │                            │
     │ [프로그레스 바 업데이트]    │
     │                            │
     │                            │── 작업 완료
     │                            │
     │<── event: complete ────────│
     │   data: {                   │
     │     "progress": 100,        │
     │     "word": "안녕하세요",    │
     │     "annotated_video_url":  │
     │       "/api/video/annotated/task_456"│
     │   }                         │
     │                            │
     │ [단어 표시]                 │
     │ [동영상 플레이어 준비]      │
```

#### 4단계: 동영상 재생
```
[클라이언트]                    [서버]
     │                            │
     │ [키포인트 표시 ON]         │
     │                            │
     │── GET /api/video/          │
     │   annotated/task_456 ─────>│
     │   Range: bytes=0-1024      │
     │                            │
     │                            │── 임시 파일 읽기
     │                            │── Range 처리
     │                            │
     │<── 206 Partial Content ────│
     │   Content-Range: 0-1024/...│
     │   [동영상 청크]             │
     │                            │
     │ [동영상 재생 시작]          │
     │                            │
     │── GET /api/video/          │
     │   annotated/task_456 ─────>│
     │   Range: bytes=1025-2048   │
     │                            │
     │<── 206 Partial Content ────│
     │   [동영상 청크]             │
     │                            │
     │ [동영상 스트리밍 계속]      │
     │                            │
     │ [사용자가 키포인트 OFF 클릭]│
     │                            │
     │── GET /api/video/          │
     │   original/task_456 ──────>│
     │                            │
     │<── 200 OK ─────────────────│
     │   [원본 동영상]             │
     │                            │
     │ [원본 동영상 재생]          │
```

---

### 시나리오 2: 단어 검색

```
[클라이언트]                    [서버]
     │                            │
     │── POST /api/search ───────>│
     │   { "word": "안녕하세요" }  │
     │                            │
     │                            │── 사전 DB 검색
     │                            │
     │<── 200 OK ─────────────────│
     │   {                         │
     │     "results": [            │
     │       {                     │
     │         "word": "안녕하세요",│
     │         "video_url":        │
     │           "/api/video/dictionary/안녕하세요_1",│
     │         "description": "..."│
     │       }                     │
     │     ]                       │
     │   }                         │
     │                            │
     │ [검색 결과 리스트 표시]     │
     │                            │
     │ [사용자가 동영상 선택]      │
     │                            │
     │── GET /api/video/          │
     │   dictionary/안녕하세요_1 ──>│
     │                            │
     │                            │── 사전 파일 읽기
     │                            │
     │<── 200 OK ─────────────────│
     │   Content-Type: video/mp4   │
     │   [동영상 데이터]            │
     │                            │
     │ [동영상 재생]               │
```

---

## 데이터 구조

### 클라이언트 상태 관리

#### 동작 검색 탭 상태
```javascript
{
  uploadedFile: {
    fileId: "abc123",
    filename: "video.mp4",
    uploaded: true
  },
  translation: {
    taskId: "task_456",
    status: "processing" | "completed" | "error",
    progress: 50,
    word: "안녕하세요",
    originalVideoUrl: "/api/video/original/task_456",
    annotatedVideoUrl: "/api/video/annotated/task_456"
  },
  player: {
    showKeypoints: true,
    currentVideoUrl: "/api/video/annotated/task_456"
  }
}
```

#### 단어 검색 탭 상태
```javascript
{
  searchResults: [
    {
      word: "안녕하세요",
      videoUrl: "/api/video/dictionary/안녕하세요_1",
      description: "표준 수어 동작"
    }
  ],
  selectedVideo: null
}
```

### 서버 임시 저장소 구조

```
/tmp/hand_server/
  ├── uploads/
  │   └── {file_id}.mp4          # 업로드된 원본 파일
  └── translations/
      └── {task_id}/
          ├── original.mp4        # 원본 파일 (심볼릭 링크)
          ├── annotated.mp4       # 키포인트 그려진 파일
          └── metadata.json       # 번역 결과 메타데이터
              {
                "word": "안녕하세요",
                "created_at": "2024-01-01T00:00:00Z",
                "expires_at": "2024-01-01T01:00:00Z"
              }
```

---

## 비동기 작업 처리

### 번역 작업 워크플로우

```
1. POST /api/translate 요청 수신
   ↓
2. 작업 큐에 추가 (task_id 생성)
   ↓
3. 즉시 task_id 반환 (비동기)
   ↓
4. 백그라운드 워커 시작:
   ├─ 동영상 분석
   ├─ 키포인트 추출
   ├─ 수어 인식 모델 실행
   ├─ 키포인트 그리기
   └─ 결과 저장
   ↓
5. SSE로 진행 상황 전송
   ↓
6. 완료 시 complete 이벤트 전송
```

### 진행 상황 이벤트 타임라인

```
0%   ── 작업 시작
10%  ── 동영상 로드 및 검증
20%  ── 프레임 추출
40%  ── 키포인트 추출
60%  ── 모델 입력 준비
80%  ── 수어 인식 모델 실행
90%  ── 키포인트 그리기
95%  ── 동영상 인코딩
100% ── 완료
```

---

## 프론트엔드-백엔드 분담

### 프론트엔드 담당
- ✅ GUI 렌더링 (HTML/CSS/JS)
- ✅ 파일 업로드 UI
- ✅ SSE 연결 및 진행 상황 표시
- ✅ 동영상 플레이어
- ✅ 키포인트 표시/숨김 토글 (동영상 URL 전환)
- ✅ 단어 검색 UI
- ✅ 검색 결과 리스트
- ✅ 에러 메시지 표시

### 백엔드 담당
- ✅ 파일 업로드 처리
- ✅ 파일 검증 및 임시 저장
- ✅ 번역 작업 큐 관리
- ✅ 동영상 처리 (키포인트 추출/그리기)
- ✅ 수어 인식 모델 실행
- ✅ SSE 스트림 관리
- ✅ 사전 데이터베이스 검색
- ✅ 동영상 스트리밍 (Range Requests)
- ✅ 임시 파일 정리 (TTL 기반)

---

## 성능 최적화 고려사항

### 동영상 스트리밍
- HTTP Range Requests 지원으로 seek 가능
- 청크 단위 전송으로 메모리 효율성
- 적절한 버퍼 크기 설정

### 파일 관리
- 업로드 후 즉시 처리 시작 (저장 최소화)
- 번역 완료 후 결과만 임시 보관
- TTL 기반 자동 삭제 (예: 1시간)

### SSE 연결
- 연결 타임아웃 설정
- 자동 재연결 메커니즘
- 진행 상황 캐싱 (재연결 시)

### 비동기 처리
- 작업 큐 사용 (Celery, RQ 등)
- 워커 풀 관리
- 진행 상황 실시간 업데이트

